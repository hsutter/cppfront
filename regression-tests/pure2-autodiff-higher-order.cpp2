
ad_order : int  == 6;
ad_type  : type == cpp2::taylor<double, ad_order>;

ad_test: @autodiff<"order=6"> @print type = {

    add_1: (x: double, y: double) -> (r: double) = {
        r = x + y;
    }

    add_2: (x: double, y: double) -> (r: double) = {
        r = x + y + x;
    }

    sub_1: (x: double, y: double) -> (r: double) = {
        r = x - y;
    }

    sub_2: (x: double, y: double) -> (r: double) = {
        r = x - y - x;
    }

    add_sub_2: (x: double, y: double) -> (r: double) = {
        r = x + y - x;
    }

    mul_1: (x: double, y: double) -> (r: double) = {
        r = x * y;
    }

    mul_2: (x: double, y: double) -> (r: double) = {
        r = x * y * x;
    }

    div_1: (x: double, y: double) -> (r: double) = {
        r = x / y;
    }

    div_2: (x: double, y: double) -> (r: double) = {
        r = x / y / y;
    }

    mul_div_2: (x: double, y: double) -> (r: double) = {
        r = x * y / x;
    }

    mul_add: (x: double, y: double) -> (r: double) = {
        r = x * (x + y);
    }

    add_mul: (x: double, y: double) -> (r: double) = {
        r = x + x * y;
    }
}

write_output: (func: std::string, x: double, x_d: ad_type, y: double, y_d: ad_type, ret) = {
    std::cout << "diff((func)$) at (x = (x)$, x_d = (x_d)$, y = (y)$, y_d = (y_d)$):" << std::endl;
    std::cout << "  r = (ret.r)$" << std::endl;
    (copy i:=1)
    while i <= ad_order next i += 1 {
      std::cout << "  d(i)$ = (ret.r_d[i])$" << std::endl;
    }
}

main: () = {


    x:   double  = 2.0;
    x_d: ad_type = 1.0;
    y:   double  = 3.0;
    y_d: ad_type = 2.0;

    write_output("x + y", x, x_d, y, y_d, ad_test::add_1_d(x, x_d, y, y_d));
    write_output("x + y + x", x, x_d, y, y_d, ad_test::add_2_d(x, x_d, y, y_d));
    write_output("x - y", x, x_d, y, y_d, ad_test::sub_1_d(x, x_d, y, y_d));
    write_output("x - y - x", x, x_d, y, y_d, ad_test::sub_2_d(x, x_d, y, y_d));
    write_output("x + y - x", x, x_d, y, y_d, ad_test::add_sub_2_d(x, x_d, y, y_d));
    write_output("x * y", x, x_d, y, y_d, ad_test::mul_1_d(x, x_d, y, y_d));
    write_output("x * y * x", x, x_d, y, y_d, ad_test::mul_2_d(x, x_d, y, y_d));
    write_output("x / y", x, x_d, y, y_d, ad_test::div_1_d(x, x_d, y, y_d));
    write_output("x / y / y", x, x_d, y, y_d, ad_test::div_2_d(x, x_d, y, y_d));
    write_output("x * y / x", x, x_d, y, y_d, ad_test::mul_div_2_d(x, x_d, y, y_d));
    write_output("x * (x + y)", x, x_d, y, y_d, ad_test::mul_add_d(x, x_d, y, y_d));
    write_output("x + x * y", x, x_d, y, y_d, ad_test::add_mul_d(x, x_d, y, y_d));
//    write_output("x * func(x, y)", x, x_d, y, y_d, ad_test::func_call_d(x, x_d, y, y_d));
//    write_output("sin(x + y)", x, x_d, y, y_d, ad_test::sin_call_d(x, x_d, y, y_d));
//    write_output("if branch", x, x_d, y, y_d, ad_test::if_branch_d(x, x_d, y, y_d));
//    write_output("if else branch", x, x_d, y, y_d, ad_test::if_else_branch_d(x, x_d, y, y_d));
//    write_output("direct return", x, x_d, y, y_d, ad_test::direct_return_d(x, x_d, y, y_d));
//    write_output("intermediate var", x, x_d, y, y_d, ad_test::intermediate_var_d(x, x_d, y, y_d));
//    write_output("intermediate passive var", x, x_d, y, y_d, ad_test::intermediate_passive_var_d(x, x_d, y, y_d));
//    write_output("intermediate untyped", x, x_d, y, y_d, ad_test::intermediate_untyped_d(x, x_d, y, y_d));
//    write_output("intermediate default init", x, x_d, y, y_d, ad_test::intermediate_default_init_d(x, x_d, y, y_d));
//    write_output("intermediate no init", x, x_d, y, y_d, ad_test::intermediate_no_init_d(x, x_d, y, y_d));
//    write_output("while loop", x, x_d, y, y_d, ad_test::while_loop_d(x, x_d, y, y_d));
//    write_output("do while loop", x, x_d, y, y_d, ad_test::do_while_loop_d(x, x_d, y, y_d));
//    write_output("for loop", x, x_d, y, y_d, ad_test::for_loop_d(x, x_d, y, y_d));
}
